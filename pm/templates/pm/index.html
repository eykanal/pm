<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Bootstrap 101 Template</title>

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
		
		<style>
		body { padding-top: 50px; }
		div.project-info { display: none; }
		</style>

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
	</head>
	<body>

		<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
			<div class="container">
				<div class="navbar-header">
					<p class="navbar-text">ProjManager 0.1</p>
					<ul class="nav navbar-nav"></ul>
				</div>
			</div>
		</nav>

		<div class="container">
			<div class="row">
				<div class="col-md-3">
					<table class="table table-hover">
						<tbody>
							<tr><td class="info" data-toggle="modal" data-target="#newProj"><h4><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add New Project</h4></td></tr>
							{% for project in projects %}
							<tr><td class="project-name" data-id="{{ project.id }}"><h4>{{ project.name }}</h4></td></tr>
							{% endfor %}
						</tbody>
					</table>
					<div id="newProj" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="newProjLabel" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<form action="" method="post" id="create-project">
									{% csrf_token %}

									<div class="modal-header">
										<h4 class="modal-title" id="newProjLabel">Add New Project</h4>
									</div>
									
									<table class="table">
									{{ proj_form.as_table }}
									</table>

									<div class="modal-footer">
										<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
										<button type="submit" class="btn btn-primary">Save changes</button>
									</div>
								</form>
							</div><!-- /.modal-content -->
						</div><!-- /.modal-dialog -->
					</div><!-- /.modal -->
				</div>
				<div class="col-md-9">
				{% for project in projects %}
				<div class="project-info" id="project-info-{{ project.id }}">
					<div class="row" id="{{ project.id }}">
						<div class="col-md-6 project-name"><h2>{{ project.name }}</h2></div>
						<div class="col-md-6">
							<table class="table table-condensed">
								<tr>
									<td>Requester:</td>
									<td>{{ project.requester }}</td>
								</tr>
								<tr>
									<td>Start Date:</td>
									<td>{{ project.start_date }}</td>
								</tr>
								<tr>
									<td>Due Date:</td>
									<td>{{ project.due_date }}</td>
								</tr>
							</table>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12 project-description">
							<p class="lead">{{ project.description }}</p>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12 workers">
						{% for worker in project.worker_set.all %}
							<div class="btn">{{ worker.person.name }}{% if worker.percent_committed <= 100 and worker.percent_committed >= 0 %} ({{ worker.percent_committed }}){% endif %}{% if worker.owner %} - owner{% endif %}</div>
						{% endfor %}
						</div>
					</div>
				</div>
				{% endfor %}

			</div>
		</div>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

		<script type="text/javascript">
		//
		// SITE INTERACTIVITY
		//

		$('.project-name').on("click", function(event){
			$(".project-info").hide();  // ensure all other views are hidden
			$("#project-info-" + event.currentTarget.dataset.id).show();
		});

		//
		// AJAX CONTENT
		//

		// ### SEE https://docs.djangoproject.com/en/dev/ref/csrf/ FOR DETAILS ON THE FOLLOWING ###
		// The following code ensures that the CSRF token is properly inserted in the header of the AJAX request

		var csrftoken = $.cookie('csrftoken');

		function csrfSafeMethod(method) {
			// these HTTP methods do not require CSRF protection
			return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}

		$.ajaxSetup({
			beforeSend: function(xhr, settings) {
				if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
					xhr.setRequestHeader("X-CSRFToken", csrftoken);
				}
			}
		});
		
		// ### END AJAX HEADER CONTENT

		// new project
		$('#create-project').on('submit', function(event){
			event.preventDefault();
		
			$.ajax({
					url: "create_project",
					type: "POST",
					dataType: "json",
					data: $('#create-project').serialize(),
					success: function(json) {
						$('#create-project').trigger('reset'); // remove the value from the input
						$('#newProj').modal('hide');
					},
					error: function(xhr,errmsg,err) {
						$('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg + "<a href='#' class='close'>&times;</a></div>");
						console.log(xhr.status + ": " + xhr.responseText);
					}
				});
			});
		</script>
	</body>
</html>