{% extends "pm/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Project Detail - {{ project.name }}{% endblock title %}

{% block content-header %}<b>{{ project.name }}</b> ({{ project.program.name }}){% endblock content-header %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="box box-solid">
            <div class="box-header">
                <i class="ion ion-clipboard"></i>
                <h3 class="box-title">Description</h3>
            </div>
            <div class="box-body">{{ project.description }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="box box-solid">
            <div class="box-header">
                <i class="fa fa-list-ul"></i>
                <h3 class="box-title">Project Details</h3>
            </div>
            <div class="box-body">
                <table class="table table-condensed">
                    <tr>
                        <td>ID:</td>
                        <td>{{ project.id | stringformat:"04d" }}</td>
                    </tr>
                    <tr>
                        <td>Requester:</td>
                        <td>{{ project.requester.full_name }}</td>
                    </tr>
                    <tr>
                        <td>Assigned to:</td>
                        <td>{% for worker in project.worker_set.all %}{% if worker.owner %}<span class="text-light-blue">{% endif %}{{ worker.person.full_name }}{% if worker.owner %}</span>{% endif %}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                    </tr>
                    <tr>
                        <td>Start Date:</td>
                        <td>{{ project.start_date }}</td>
                    </tr>
                    <tr>
                        <td>Due Date:</td>
                        <td>{{ project.due_date }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="row new-task">
    <div class="alert alert-danger alert-dismissable">
        <h4>Error!</h4>
        <p>An error was encountered while saving the form. Please try again shortly.</p>
    </div>
    <div class="alert alert-success alert-dismissable">
        <i class="fa fa-check"></i>
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
        <p>Task successfully entered!</p>
    </div>
    <div class="col-md-12">
        <div class="box box-solid box-info">
            <div class="box-header">
                <h3 class="box-title">New Task</h3>
            </div>
            <div class="box-body">
                {% crispy taskform %}
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="box box-solid">
            <div class="box-header">
                <i class="fa fa-tasks"></i>
                <h3 class="box-title">Tasks</h3>
            </div>
            <div class="box-body">
                <table class="table">
                    <tr>
                        <th class="center vcenter" width="10%">Name</th>
                        <th class="center vcenter">Description</th>
                        <th class="center vcenter" width="10%">Start Date</th>
                        <th class="center vcenter" width="10%">Due Date</th>
                        <th class="center vcenter" width="10%">Completed Date</th>
                        <th class="center vcenter" width="10%">Assigned To</th>
                    </tr>
                    {% for task in project.task_set.all %}
                    <tr>
                        <td>{{ task.name }}</td>
                        <td>{{ task.description }}</td>
                        <td class="center">{{ task.start_date }}</td>
                        <td class="center">{{ task.due_date }}</td>
                        <td class="center">{{ task.date_completed }}</td>
                        <td>{% for taskworker in task.taskworker_set.all %}{{ taskworker.worker.person.full_name }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
"use strict";

$(document).keydown(function(e) {
    // "n" or "N" opens new task window
    if(e.which == 78) {
        $(".new-task").show();
        $(".new-task .box").show();
        $(".new-task .alert").hide();
    }
    // "esc" hides new task window
    if(e.which == 27) {
        $(".new-task").hide();
    }
});

//
// AJAX CONTENT
//

// ### SEE https://docs.djangoproject.com/en/dev/ref/csrf/ FOR DETAILS ON THE FOLLOWING ###
// The following code ensures that the CSRF token is properly inserted in the header of the AJAX request

var csrftoken = $.cookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

// ### END AJAX HEADER CONTENT

// new task
function process_submit (event) {
    event.preventDefault();

    $.ajax({
            url: "{% url 'pm:task-new' %}",
            type: "POST",
            dataType: "json",
            data: $('#create-task').serialize(),
            success: function(data) {
                if(!(data['success'])) {
                    $('#create-task').replaceWith(data['form_html']);
                    $('#create-task').on('submit', process_submit);  // need to bind the function to the new element
                } else {
                    $('.new-task .box').hide();
                    $('.new-task .alert-success').show();
                    $('#create-task').trigger('reset'); // remove the value from the input
                }
            },
            error: function(xhr,errmsg,err) {
                $('.new-task .alert-error').show();
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
};

$('#create-task').on('submit', process_submit);

{% endblock %}
